<html>
    <head>
        <title>Flight Alert</title>

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin=""/>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

        <style>
            html, body {
               margin:0px;
            }

            #side-bar {
                width: 500px;
                height: 100%;
                float: left;
            }

            #map { 
                margin-left: 500px;
                height: 100%;
                position: relative;
            }

            .leaflet-popup-close-button {
            display: none;
            }

            .myDivIcon {
                text-align: center;
                /* Horizontally center the text (icon) */
                line-height: 20px;
                /* Vertically center the text (icon) */
                }
        </style>

        <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>

        
    </head>
    <body>
        <div id="main">
            <div id="side-bar">
                hi
            </div>

            <div id="map" class="leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom"></div>
        </div>

        <script>
            let hospitals = null;
            let flights = {};
            let mapFlights = {};
            let mapHospitals = [];

            /***   Start: Helper functions   ***/
            let feetToMeters = (feet) => { return 0.3048 * feet }
            let metersToFeet = (meters) => { return 3.28 * meters }

            /***   Start: Helper functions   ***/

            /***   Start: Map   ***/
            const bbox = [[37, -88.028], [41.762, -84.809]];

            var map = L.map('map').fitBounds(bbox);

            var tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            var layerControl = L.control.layers(
                {"Streets": tiles}, 
                {}).addTo(map);

            //let x = L.marker(["40", "-86"]).addTo(map);

            const hospitalIcon = L.divIcon({
                html: '<i class="fa-solid fa-hospital fa-2x" style="color:f7786b;"></i>',
                iconSize: [20, 20],
                className: 'myDivIcon'
            });

            /***   End: Map   ***/
        

            // Draw hospitals
            let drawHospitals = (map, hospitals) => {
                for(let h in hospitals) {
                    let hosp = hospitals[h]
                    //L.circle([hosp.latitude, hosp.longitude], {radius: feetToMeters(hosp.zone1.radius)}).addTo(map)
                    mapHospitals.push(L.marker([hosp.latitude, hosp.longitude], {icon: hospitalIcon}).addTo(map))
                }

                layerControl.addOverlay(L.layerGroup(mapHospitals), "Hospitals");
            }

            let reDrawAirCraft = () => {
                for(let f in flights) {
                    if(!flights[f].updated)
                        continue
                    
                    if(mapFlights[f]) {
                        mapFlights[f].setLatLng([flights[f].latest.latitude, flights[f].latest.longitude]); 
                    }
                    else {
                        mapFlights[f] = L.marker([flights[f].latest.latitude, flights[f].latest.longitude]).addTo(map)
                    }
                }
            }

            let updatedFlights = (newFlights) => {
                flights = newFlights;

                reDrawAirCraft();
            }

            /***   Start: Sockets   ***/
            var socket = io();
            socket.on('nfd', (data) => {
                console.log(data);
                updatedFlights(data);
            });

            /***   End: Sockets   ***/

            /***   Start: Pull data   ***/
            // Get hospital list
            fetch('http://localhost:3000/hospitals.json')
                .then(res => res.json())
                .then((out) => {
                    hospitals = out;
                    drawHospitals(map, out);
            }).catch(err => console.error(err));
            /*** End: Pull data   ***/
        </script>
    </body>

    
</html>